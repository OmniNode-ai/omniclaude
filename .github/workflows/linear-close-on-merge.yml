# SPDX-FileCopyrightText: 2025 OmniNode.ai Inc.
# SPDX-License-Identifier: MIT

# linear-close-on-merge.yml
#
# Auto-close Linear tickets when their associated PR merges.
#
# Fires on pull_request closed events. When the PR was actually merged
# (not just closed), extracts the OMN-XXXX ticket ID from the branch name
# and calls the Linear API to mark the ticket as Done.
#
# This workflow is the belt-and-suspenders fallback when the Claude Code
# session that created the PR has already ended (e.g. CI was still running
# when the session closed). The ticket-pipeline Phase 6 auto_merge step
# is the primary path; this workflow catches any tickets missed by that path.
#
# Branch name conventions supported:
#   jonahgabriel/omn-XXXX-description  (Linear default)
#   jonah/omn-XXXX-description          (short username variant)
#   epic/OMN-XXXX/OMN-YYYY/run-id       (epic-team branches, closes child OMN-YYYY)
#   OMN-XXXX-description                (bare prefix variant)
#
# Implements OMN-3262.

name: Close Linear Ticket on PR Merge

on:
  pull_request:
    types: [closed]
    branches:
      - main
      - develop

jobs:
  close-linear-ticket:
    name: Close Linear Ticket
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Extract ticket ID from branch name
        id: extract
        env:
          BRANCH: ${{ github.event.pull_request.head.ref }}
        shell: bash
        run: |
          echo "Branch: $BRANCH"

          # Pattern 1: jonahgabriel/omn-XXXX-... or jonah/omn-XXXX-...
          # Pattern 2: epic/OMN-XXXX/OMN-YYYY/run-id  (use the child ticket OMN-YYYY)
          # Pattern 3: omn-XXXX-... or OMN-XXXX-...   (bare prefix)

          TICKET_ID=""

          # Try to extract from epic branch: epic/OMN-XXXX/OMN-YYYY/...
          if echo "$BRANCH" | grep -qiE "^epic/OMN-[0-9]+/(OMN-[0-9]+)/"; then
            TICKET_ID=$(echo "$BRANCH" | grep -ioE "^epic/OMN-[0-9]+/(OMN-[0-9]+)/" | grep -ioE "OMN-[0-9]+" | tail -1)
          fi

          # Try standard branch: */omn-XXXX-* or */OMN-XXXX-*
          if [[ -z "$TICKET_ID" ]]; then
            TICKET_ID=$(echo "$BRANCH" | grep -ioE "(OMN|omn)-[0-9]+" | head -1 | tr '[:lower:]' '[:upper:]')
          fi

          if [[ -z "$TICKET_ID" ]]; then
            echo "No OMN-XXXX ticket ID found in branch '$BRANCH' — skipping."
            echo "ticket_id=" >> "$GITHUB_OUTPUT"
          else
            echo "Extracted ticket ID: $TICKET_ID"
            echo "ticket_id=$TICKET_ID" >> "$GITHUB_OUTPUT"
          fi

      - name: Close Linear ticket
        if: steps.extract.outputs.ticket_id != ''
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          TICKET_ID: ${{ steps.extract.outputs.ticket_id }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          REPO: ${{ github.repository }}
        shell: bash
        run: |
          echo "Marking $TICKET_ID as Done (PR #$PR_NUMBER merged in $REPO)"

          # Search for the ticket by identifier using the Linear GraphQL API
          SEARCH_RESPONSE=$(curl -s -X POST https://api.linear.app/graphql \
            -H "Authorization: $LINEAR_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"{ issue(id: \\\"$TICKET_ID\\\") { id identifier title state { name } } }\"}" \
            2>&1)

          echo "Search response: $SEARCH_RESPONSE"

          # Extract the internal UUID
          ISSUE_ID=$(echo "$SEARCH_RESPONSE" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          issue = data.get('data', {}).get('issue')
          if issue:
              print(issue['id'])
          else:
              print('')
          " 2>/dev/null || echo "")

          if [[ -z "$ISSUE_ID" ]]; then
            echo "Could not find Linear issue for $TICKET_ID — skipping."
            exit 0
          fi

          CURRENT_STATE=$(echo "$SEARCH_RESPONSE" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          issue = data.get('data', {}).get('issue')
          if issue:
              print(issue.get('state', {}).get('name', ''))
          else:
              print('')
          " 2>/dev/null || echo "")

          echo "Issue $TICKET_ID (ID: $ISSUE_ID) current state: $CURRENT_STATE"

          # Only mark Done if not already Done/Cancelled/Duplicate
          if echo "$CURRENT_STATE" | grep -qiE "^(done|cancelled|duplicate|completed)$"; then
            echo "$TICKET_ID is already in state '$CURRENT_STATE' — no update needed."
            exit 0
          fi

          # Look up the "Done" state ID for this team
          TEAM_RESPONSE=$(curl -s -X POST https://api.linear.app/graphql \
            -H "Authorization: $LINEAR_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"{ issue(id: \\\"$TICKET_ID\\\") { team { id states { nodes { id name type } } } } }\"}" \
            2>&1)

          DONE_STATE_ID=$(echo "$TEAM_RESPONSE" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          states = (data.get('data', {})
                        .get('issue', {})
                        .get('team', {})
                        .get('states', {})
                        .get('nodes', []))
          for s in states:
              if s.get('type', '').upper() == 'COMPLETED':
                  print(s['id'])
                  break
          " 2>/dev/null || echo "")

          if [[ -z "$DONE_STATE_ID" ]]; then
            echo "Could not resolve Done state ID for team — skipping update."
            exit 0
          fi

          # Update the ticket state to Done
          UPDATE_RESPONSE=$(curl -s -X POST https://api.linear.app/graphql \
            -H "Authorization: $LINEAR_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"mutation { issueUpdate(id: \\\"$ISSUE_ID\\\", input: { stateId: \\\"$DONE_STATE_ID\\\" }) { success issue { id state { name } } } }\"}" \
            2>&1)

          echo "Update response: $UPDATE_RESPONSE"

          SUCCESS=$(echo "$UPDATE_RESPONSE" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          print(data.get('data', {}).get('issueUpdate', {}).get('success', False))
          " 2>/dev/null || echo "False")

          if [[ "$SUCCESS" == "True" ]]; then
            echo "Successfully marked $TICKET_ID as Done."
          else
            echo "WARNING: Failed to mark $TICKET_ID as Done. Response: $UPDATE_RESPONSE"
            # Non-fatal: do not fail the workflow for a Linear update failure
            exit 0
          fi
