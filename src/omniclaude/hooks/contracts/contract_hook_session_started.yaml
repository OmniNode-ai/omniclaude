# SPDX-License-Identifier: MIT
# Copyright (c) 2025 OmniNode Team
#
# ONEX Node Contract
# Node: NodeHookSessionStartedEffect
#
# This contract defines the interface for the session started hook effect node,
# which emits events to Kafka when a Claude Code session starts.

# Contract identifiers
name: "hook_session_started"
contract_name: "hook_session_started"
node_name: "hook_session_started"

# Version (semantic versioning)
version:
  major: 1
  minor: 0
  patch: 0
contract_version:
  major: 1
  minor: 0
  patch: 0
node_version:
  major: 0
  minor: 1
  patch: 0

# Node type - EFFECT because it publishes to Kafka (side effect)
node_type: "EFFECT"

# Description
description: >
  Effect node for emitting session started events. When a Claude Code session
  starts (via SessionStart hook), this node publishes a ModelHookSessionStartedPayload
  event to Kafka for downstream learning and analytics. Captures working directory,
  git branch, and hook trigger source.

# Strongly typed I/O models
input_model:
  name: "ModelHookSessionStartedPayload"
  module: "omniclaude.hooks.schemas"
  description: "Session started event payload with session context."
output_model:
  name: "ModelEventPublishResult"
  module: "omniclaude.hooks.models"
  description: "Result of publishing event to Kafka (success, offset, partition)."

# Event bus configuration
event_bus:
  topic_base: "omniclaude.session.started.v1"
  partition_key_field: "entity_id"
  partition_strategy: "hash"
  # Events use entity_id (session UUID) for ordering guarantees within a session

# Runtime configuration
runtime:
  # Invoked by Claude Code hooks (not orchestrator)
  supports_direct_call: true
  # Can be event-driven in future learning pipelines
  supports_event_driven: true
  # Publishes to Kafka - has side effects
  side_effects: true
  # Hook must complete quickly
  timeout_ms: 500
  # Same input always produces same event (deterministic serialization)
  deterministic: true

# ONEX timestamp policy
timestamp_policy:
  # emitted_at has NO default_factory per ONEX architecture
  explicit_injection: true
  timezone_required: true
  rationale: >
    Producers must explicitly inject timestamps. This ensures deterministic
    testing (fixed time in tests), consistent ordering (no clock skew between
    services), and explicit time dependencies.

# Dependencies
dependencies:
  - name: "kafka_producer"
    type: "service"
    description: "Kafka producer for publishing events"
  - name: "topic_builder"
    type: "utility"
    class_name: "build_topic"
    module: "omniclaude.hooks.topics"
    description: "Utility for building full topic names with prefix"
  - name: "validate_timezone_aware_datetime"
    type: "utility"
    module: "omnibase_infra.utils"
    description: "Validates timestamp is timezone-aware"

# Capabilities provided by this node
capabilities:
  - name: "session_event_emission"
    description: "Emit session started events to Kafka"
  - name: "causation_tracking"
    description: "Include causation_id for event chain tracing"
  - name: "correlation_tracking"
    description: "Include correlation_id for distributed tracing"
  - name: "git_context_capture"
    description: "Capture git branch for repository context"

# Model definitions (reference - actual models in schemas.py)
definitions:
  ModelHookSessionStartedPayload:
    type: object
    description: "Event payload for Claude Code session start"
    properties:
      entity_id:
        type: string
        format: uuid
        description: "Session identifier as UUID (partition key for ordering)"
      session_id:
        type: string
        minLength: 1
        description: "Session identifier string"
      correlation_id:
        type: string
        format: uuid
        description: "Correlation ID for distributed tracing"
      causation_id:
        type: string
        format: uuid
        description: "ID of the event or trigger that caused this event"
      emitted_at:
        type: string
        format: date-time
        description: "Timestamp when the hook emitted this event (UTC, timezone-aware)"
      working_directory:
        type: string
        description: "Current working directory of the session"
      git_branch:
        type: string
        nullable: true
        description: "Current git branch if in a git repository"
      hook_source:
        type: string
        enum: ["startup", "resume", "clear", "compact"]
        description: "What triggered the session start"
    required:
      - entity_id
      - session_id
      - correlation_id
      - causation_id
      - emitted_at
      - working_directory
      - hook_source

  ModelEventPublishResult:
    type: object
    description: "Result of publishing event to Kafka"
    properties:
      success:
        type: boolean
        description: "Whether the event was successfully published"
      topic:
        type: string
        minLength: 1
        description: "The Kafka topic the event was published to"
      partition:
        type: integer
        nullable: true
        minimum: 0
        description: "The partition the event was assigned to (if successful)"
      offset:
        type: integer
        nullable: true
        minimum: 0
        description: "The offset within the partition (if successful)"
      error_message:
        type: string
        nullable: true
        maxLength: 1000
        description: "Error details if publishing failed"
    required:
      - success
      - topic

# Metadata
metadata:
  author: "OmniNode Team"
  license: "MIT"
  created: "2025-01-19"
  ticket: "OMN-1399"
  tags:
    - effect
    - hook
    - session
    - kafka
    - event
    - omniclaude
    - onex
