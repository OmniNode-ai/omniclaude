# SPDX-License-Identifier: MIT
# Copyright (c) 2025 OmniNode Team
#
# ONEX Node Contract
# Node: NodeGitEffect
#
# Capability-oriented effect node for git operations.
# Named by capability ("git.operations"), not by vendor.
# Principle: "I'm interested in what you do, not what you are"
#
# INVARIANT: No subprocess 'git' or 'gh' calls outside this effect node.
# All PRs created via this node include a mandatory ticket stamp block.

# Contract identifiers
name: node_git_effect
contract_name: node_git_effect
node_name: node_git_effect

contract_version:
  major: 1
  minor: 0
  patch: 0

node_version:
  major: 1
  minor: 0
  patch: 0

# Node type
node_type: EFFECT_GENERIC

# Description
description: >
  Capability-oriented effect node for git operations.
  Handles branch management, commits, pushes, and pull request lifecycle
  with pluggable backends. Every PR body created via this node contains
  a mandatory ticket stamp block.

# Strongly typed I/O models
input_model:
  name: ModelGitRequest
  module: omniclaude.nodes.node_git_effect.models

output_model:
  name: ModelGitResult
  module: omniclaude.nodes.node_git_effect.models

# Capabilities
capabilities:
  - name: git.operations
    description: All git and GitHub CLI operations
    version: 1.0.0

  - name: git.operations.branch_create
    description: Create a new git branch from base

  - name: git.operations.commit
    description: Stage and commit changes with a message

  - name: git.operations.push
    description: Push a branch to the remote

  - name: git.operations.pr_create
    description: Create a pull request with mandatory ticket stamp block

  - name: git.operations.pr_update
    description: Update title, body, or labels of an existing PR

  - name: git.operations.pr_close
    description: Close a pull request without merging

# IO operations
io_operations:
  - operation: branch_create
    description: Create a new git branch
    protocol_method: branch_create
    input_fields:
      - branch_name: str
      - base_ref: str
      - correlation_id: UUID | None
    output_fields:
      - result: ModelGitResult
    idempotent: false

  - operation: commit
    description: Stage all changes and create a commit
    protocol_method: commit
    input_fields:
      - message: str
      - correlation_id: UUID | None
    output_fields:
      - result: ModelGitResult
    idempotent: false

  - operation: push
    description: Push branch to remote
    protocol_method: push
    input_fields:
      - branch_name: str
      - force: bool
      - correlation_id: UUID | None
    output_fields:
      - result: ModelGitResult
    idempotent: true

  - operation: pr_create
    description: Create pull request with mandatory ticket stamp block
    protocol_method: pr_create
    input_fields:
      - title: str
      - body: str
      - ticket_id: str
      - base_branch: str
      - correlation_id: UUID | None
    output_fields:
      - result: ModelGitResult
    idempotent: false

  - operation: pr_update
    description: Update existing pull request
    protocol_method: pr_update
    input_fields:
      - pr_number: int
      - title: str | None
      - body: str | None
      - correlation_id: UUID | None
    output_fields:
      - result: ModelGitResult
    idempotent: true

  - operation: pr_close
    description: Close pull request without merging
    protocol_method: pr_close
    input_fields:
      - pr_number: int
      - correlation_id: UUID | None
    output_fields:
      - result: ModelGitResult
    idempotent: true

# Dependencies
dependencies:
  - name: protocol_git_operations
    type: protocol
    class_name: ProtocolGitOperations
    module: omniclaude.nodes.node_git_effect.protocols
    pluggable: true

# Handler routing
handler_routing:
  routing_strategy: backend_match
  default_backend: subprocess
  backends:
    - backend: subprocess
      handler_key: subprocess

# Invariants
invariants:
  - all_prs_include_ticket_stamp: true
  - no_subprocess_outside_handler: true

# Error handling
error_handling:
  retry_policy:
    max_retries: 2
    initial_delay_ms: 500
    max_delay_ms: 5000
    exponential_base: 2
    retry_on:
      - GitNetworkError
      - GitTimeoutError
  circuit_breaker:
    enabled: false

# Metadata
metadata:
  author: OmniNode Team
  license: MIT
  ticket: OMN-2593
  maturity: stub
  tags:
    - effect
    - git
    - github
    - pull-request
