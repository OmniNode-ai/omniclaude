# Docker Compose Test Environment for Kafka Agent Logging
# Includes: Redpanda (Kafka-compatible), PostgreSQL, Consumer Service
# Purpose: Integration/E2E testing for agent action logging system

version: '3.8'

services:
  # ============================================================================
  # Redpanda (Kafka-compatible broker)
  # ============================================================================
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v23.3.3
    container_name: omniclaude_test_redpanda
    command:
      - redpanda
      - start
      - --kafka-addr
      - internal://0.0.0.0:9092,external://0.0.0.0:29092
      - --advertise-kafka-addr
      - internal://redpanda:9092,external://localhost:29092
      - --pandaproxy-addr
      - internal://0.0.0.0:8082,external://0.0.0.0:28082
      - --advertise-pandaproxy-addr
      - internal://redpanda:8082,external://localhost:28082
      - --schema-registry-addr
      - internal://0.0.0.0:8081,external://0.0.0.0:28081
      - --rpc-addr
      - redpanda:33145
      - --advertise-rpc-addr
      - redpanda:33145
      - --mode
      - dev-container
      - --smp
      - '1'
      - --default-log-level=info
    ports:
      - "29092:29092"  # Kafka external
      - "28082:28082"  # Pandaproxy external
      - "28081:28081"  # Schema registry external
      - "9644:9644"    # Admin API
    networks:
      - test_network
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health | grep -q 'Healthy:.*true'"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
    volumes:
      - redpanda_test_data:/var/lib/redpanda/data

  # ============================================================================
  # PostgreSQL Database for Testing
  # ============================================================================
  postgres:
    image: postgres:16-alpine
    container_name: omniclaude_test_postgres
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=omninode-bridge-postgres-dev-2024
      - POSTGRES_DB=omninode_bridge
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8
    ports:
      - "5436:5432"
    networks:
      - test_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d omninode_bridge"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
      - ./tests/init-test-db.sql:/docker-entrypoint-initdb.d/init-test-db.sql:ro

  # ============================================================================
  # Kafka Agent Action Consumer (for integration testing)
  # ============================================================================
  consumer:
    build:
      context: .
      dockerfile: Dockerfile.test-consumer
    container_name: omniclaude_test_consumer
    environment:
      - KAFKA_BROKERS=redpanda:9092
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=omninode-bridge-postgres-dev-2024
      - POSTGRES_DATABASE=omninode_bridge
      - BATCH_SIZE=100
      - BATCH_TIMEOUT_SECONDS=2.0
      - LOG_LEVEL=INFO
    depends_on:
      redpanda:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - test_network
    restart: unless-stopped

  # ============================================================================
  # Redpanda Console (optional - for debugging)
  # ============================================================================
  console:
    image: docker.redpanda.com/redpandadata/console:v2.3.8
    container_name: omniclaude_test_console
    entrypoint: /bin/sh
    command: -c 'echo "$$CONSOLE_CONFIG_FILE" > /tmp/config.yml; /app/console'
    environment:
      CONFIG_FILEPATH: /tmp/config.yml
      CONSOLE_CONFIG_FILE: |
        kafka:
          brokers: ["redpanda:9092"]
          schemaRegistry:
            enabled: true
            urls: ["http://redpanda:8081"]
        redpanda:
          adminApi:
            enabled: true
            urls: ["http://redpanda:9644"]
    ports:
      - "8080:8080"
    networks:
      - test_network
    depends_on:
      - redpanda
    profiles:
      - debug  # Only start with --profile debug

  # ============================================================================
  # Test Runner (runs pytest in isolated container)
  # ============================================================================
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.test-runner
    container_name: omniclaude_test_runner
    environment:
      - KAFKA_BROKERS=redpanda:9092
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=omninode-bridge-postgres-dev-2024
      - POSTGRES_DATABASE=omninode_bridge
      - PYTHONUNBUFFERED=1
      - DEBUG=true
    depends_on:
      redpanda:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - test_network
    volumes:
      - ./tests:/app/tests:ro
      - ./agents:/app/agents:ro
      - ./skills:/app/skills:ro
      - ./test-results:/app/test-results
    command: >
      sh -c "
        echo 'ðŸ§ª Waiting for services to be ready...' &&
        sleep 5 &&
        echo 'ðŸ§ª Running unit tests...' &&
        pytest tests/test_kafka_logging.py -v --tb=short --junitxml=/app/test-results/unit.xml &&
        echo 'ðŸ§ª Running integration tests...' &&
        pytest tests/test_kafka_consumer.py -v --tb=short --junitxml=/app/test-results/integration.xml &&
        echo 'ðŸ§ª Running e2e tests...' &&
        pytest tests/test_e2e_agent_logging.py -v --tb=short --junitxml=/app/test-results/e2e.xml &&
        echo 'ðŸ§ª Running performance tests...' &&
        pytest tests/test_logging_performance.py -v --tb=short -m performance --junitxml=/app/test-results/performance.xml &&
        echo 'âœ… All tests completed!'
      "
    profiles:
      - test  # Only start with --profile test

# ============================================================================
# Networks
# ============================================================================
networks:
  test_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/16

# ============================================================================
# Volumes
# ============================================================================
volumes:
  redpanda_test_data:
    driver: local
  postgres_test_data:
    driver: local
