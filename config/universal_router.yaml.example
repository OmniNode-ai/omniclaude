# Universal Agent Router Configuration
# This file provides a template for configuring the Universal Agent Router
# Copy to universal_router.yaml and customize for your environment

version: "1.0.0"

# Service Configuration
service:
  name: "universal-router"
  host: "0.0.0.0"
  http_port: 8070
  grpc_port: 50051
  log_level: "INFO"  # DEBUG, INFO, WARNING, ERROR, CRITICAL

  # Performance tuning
  max_concurrent_requests: 100
  request_timeout_ms: 5000
  worker_processes: 4  # CPU cores for uvicorn
  worker_class: "uvicorn.workers.UvicornWorker"

# PostgreSQL Configuration
database:
  host: "192.168.86.200"
  port: 5436
  database: "omninode_bridge"
  user: "postgres"
  password: "${POSTGRES_PASSWORD}"  # Set via environment variable

  # Connection pooling
  min_connections: 5
  max_connections: 20
  connection_timeout_seconds: 30

  # Performance
  statement_timeout_ms: 10000
  idle_in_transaction_session_timeout_ms: 60000

# Valkey/Redis Cache Configuration
cache:
  host: "localhost"
  port: 6379
  database: 0
  password: null  # Set if authentication required

  # Cache strategy
  ttl_seconds: 3600  # 1 hour default TTL
  max_memory_mb: 512
  eviction_policy: "allkeys-lru"

  # Performance
  cache_hit_rate_target: 0.65  # 65% target
  cache_warming_enabled: true
  cache_warming_limit: 100  # Top 100 common requests

# Kafka/Redpanda Configuration
kafka:
  bootstrap_servers: "omninode-bridge-redpanda:9092"  # Docker internal
  # bootstrap_servers: "192.168.86.200:29092"  # Host scripts

  # Topics
  topic_prefix: "universal-router"
  topics:
    routing_requested: "universal-router.routing.requested.v1"
    routing_completed: "universal-router.routing.completed.v1"
    routing_failed: "universal-router.routing.failed.v1"

  # Consumer configuration
  consumer_group_id: "universal-router-consumer"
  consumer_auto_offset_reset: "latest"
  consumer_enable_auto_commit: true

  # Producer configuration
  producer_acks: "all"
  producer_retries: 3
  producer_compression_type: "snappy"

  # Performance
  consumer_max_poll_records: 100
  producer_batch_size_bytes: 16384
  producer_linger_ms: 10

# vLLM GPU Integration
vllm:
  enabled: true
  base_url: "http://192.168.86.200:11434/v1"
  model: "meta-llama/Llama-3.1-8B-Instruct"

  # Performance
  timeout_ms: 100
  max_tokens: 512
  temperature: 0.1
  top_p: 0.9

  # Connection pooling
  max_connections: 20
  connection_timeout_seconds: 5

  # Retry logic
  max_retries: 2
  retry_backoff_seconds: 0.5

  # Cost tracking
  estimated_cost_per_request_usd: 0.000004  # ~$4 per 1M requests

# Fuzzy Fallback Configuration
fuzzy:
  enabled: true
  min_confidence: 0.6

  # Matching algorithm
  algorithm: "token_sort_ratio"  # token_sort_ratio, partial_ratio, ratio
  score_cutoff: 60  # 0-100

  # Agent registry
  registry_path: "~/.claude/agent-definitions"
  registry_cache_ttl_seconds: 300  # 5 minutes
  registry_watch_enabled: true  # Watch for file changes

# Remote LLM Fallback Configuration
remote_llm:
  enabled: true
  min_confidence: 0.0  # Accept any confidence (last resort)

  # Provider priority (first available)
  providers:
    - name: "anthropic"
      model: "claude-3-haiku-20240307"
      api_key: "${ANTHROPIC_API_KEY}"
      cost_per_request_usd: 0.003
      timeout_ms: 500
      max_retries: 2

    - name: "gemini"
      model: "gemini-1.5-flash"
      api_key: "${GEMINI_API_KEY}"
      cost_per_request_usd: 0.002
      timeout_ms: 500
      max_retries: 2

    - name: "together"
      model: "meta-llama/Llama-3-8b-chat-hf"
      api_key: "${TOGETHER_API_KEY}"
      cost_per_request_usd: 0.001
      timeout_ms: 500
      max_retries: 2

  # Provider selection strategy
  selection_strategy: "round_robin"  # round_robin, cheapest_first, fastest_first

# Tier Orchestration
tiers:
  # Tier 1: Valkey Cache
  cache:
    enabled: true
    priority: 1
    timeout_ms: 10

  # Tier 2: vLLM GPU
  vllm:
    enabled: true
    priority: 2
    min_confidence: 0.7
    timeout_ms: 100
    fallback_on_timeout: true
    fallback_on_low_confidence: true

  # Tier 3: Fuzzy Fallback
  fuzzy:
    enabled: true
    priority: 3
    min_confidence: 0.6
    timeout_ms: 50
    fallback_on_low_confidence: true

  # Tier 4: Remote LLM
  remote:
    enabled: true
    priority: 4
    min_confidence: 0.0
    timeout_ms: 1000
    max_usage_percent: 5.0  # Alert if >5% of requests use remote

# Rate Limiting
rate_limiting:
  enabled: true

  # Per-user limits
  per_user:
    requests_per_minute: 100
    requests_per_hour: 1000
    requests_per_day: 10000

  # Per-IP limits
  per_ip:
    requests_per_minute: 200
    requests_per_hour: 2000
    requests_per_day: 20000

  # Per-session limits
  per_session:
    requests_per_minute: 50
    requests_per_hour: 500

  # Response
  response_code: 429
  response_message: "Rate limit exceeded. Please retry after {retry_after} seconds."
  include_retry_after_header: true

# Circuit Breaker
circuit_breaker:
  enabled: true

  # vLLM circuit breaker
  vllm:
    failure_threshold: 5
    recovery_timeout_seconds: 60
    expected_exception_types:
      - "TimeoutError"
      - "ConnectionError"
      - "VLLMUnavailableError"

  # Remote LLM circuit breaker
  remote_llm:
    failure_threshold: 3
    recovery_timeout_seconds: 30
    expected_exception_types:
      - "APIError"
      - "TimeoutError"
      - "RateLimitError"

  # Database circuit breaker
  database:
    failure_threshold: 10
    recovery_timeout_seconds: 120
    expected_exception_types:
      - "OperationalError"
      - "InterfaceError"

# Observability
observability:
  # Prometheus metrics
  prometheus:
    enabled: true
    port: 8070
    path: "/metrics"

  # OpenTelemetry tracing
  opentelemetry:
    enabled: true
    exporter: "jaeger"
    jaeger_endpoint: "http://localhost:14268/api/traces"
    service_name: "universal-router"

  # Logging
  logging:
    level: "INFO"
    format: "json"  # json, text
    output: "stdout"  # stdout, file, both
    file_path: "/var/log/universal-router/app.log"
    rotation: "daily"
    retention_days: 30

# Security
security:
  # CORS
  cors:
    enabled: true
    allow_origins:
      - "http://localhost:3000"
      - "https://omniclaude.ai"
    allow_methods:
      - "GET"
      - "POST"
      - "OPTIONS"
    allow_headers:
      - "Content-Type"
      - "Authorization"
      - "X-Correlation-ID"
    allow_credentials: true

  # Authentication (optional)
  authentication:
    enabled: false
    type: "api_key"  # api_key, jwt, oauth2
    api_key_header: "X-API-Key"
    api_keys:
      - "${API_KEY_1}"
      - "${API_KEY_2}"

  # TLS/SSL (optional)
  tls:
    enabled: false
    cert_file: "/etc/ssl/certs/universal-router.crt"
    key_file: "/etc/ssl/private/universal-router.key"
    ca_file: "/etc/ssl/certs/ca.crt"

# Feature Flags
features:
  # Multi-protocol support
  http_enabled: true
  grpc_enabled: true
  kafka_enabled: true
  websocket_enabled: true

  # Advanced features
  semantic_caching_enabled: false  # Phase 5+
  multi_model_vllm_enabled: false  # Phase 5+
  agent_performance_tracking_enabled: false  # Phase 5+

  # Experimental features
  ml_powered_routing_enabled: false
  adaptive_tier_selection_enabled: false

# Cost Management
cost_management:
  # Budget alerts
  daily_budget_usd: 10.0
  weekly_budget_usd: 50.0
  monthly_budget_usd: 200.0

  # Alert thresholds
  alert_threshold_percent: 80.0  # Alert at 80% of budget

  # Cost tracking
  track_per_user: true
  track_per_session: true
  track_per_framework: true

  # Cost optimization
  prefer_cheaper_tier_on_budget_limit: true
  disable_remote_llm_on_budget_exceeded: false

# Agent Registry
agent_registry:
  # Registry location
  path: "~/.claude/agent-definitions"
  format: "yaml"  # yaml, json

  # Registry loading
  auto_reload_enabled: true
  reload_interval_seconds: 300  # 5 minutes

  # Agent filtering
  include_patterns:
    - "agent-*.yaml"
  exclude_patterns:
    - "agent-*.test.yaml"
    - "agent-*.deprecated.yaml"

  # Compatibility
  filter_by_framework: true
  default_framework: "claude-code"

# Health Checks
health:
  # Overall health endpoint
  endpoint: "/v1/health"

  # Tier health checks
  check_valkey: true
  check_vllm: true
  check_fuzzy: true
  check_remote_llm: true
  check_database: true
  check_kafka: true

  # Health check intervals
  check_interval_seconds: 10
  check_timeout_seconds: 5

  # Degraded state threshold
  degraded_threshold: 2  # If <2 tiers healthy, mark as degraded
  unhealthy_threshold: 1  # If <1 tier healthy, mark as unhealthy

# Performance Tuning
performance:
  # Request batching (for vLLM)
  batching_enabled: true
  batch_size: 16
  batch_timeout_ms: 50

  # Connection pooling
  connection_pool_size: 20
  connection_pool_timeout_seconds: 30

  # Async processing
  async_workers: 4
  async_queue_size: 1000

  # Caching
  enable_response_caching: true
  enable_agent_registry_caching: true
  enable_prompt_template_caching: true

# Development Settings (override in dev environment)
development:
  debug_mode: false
  reload_on_change: false
  mock_vllm_enabled: false
  mock_remote_llm_enabled: false
  skip_authentication: false
  verbose_logging: false

  # Testing
  test_mode: false
  test_data_path: "./tests/data"
  test_fixtures_enabled: false

# Production Settings (override in prod environment)
production:
  debug_mode: false
  reload_on_change: false
  mock_vllm_enabled: false
  mock_remote_llm_enabled: false
  skip_authentication: false
  verbose_logging: false

  # Production hardening
  enable_rate_limiting: true
  enable_circuit_breaker: true
  enable_authentication: true
  enable_tls: true

  # Monitoring
  enable_prometheus: true
  enable_opentelemetry: true
  enable_health_checks: true

# Notes:
# - Environment variables can be used with ${VAR_NAME} syntax
# - Copy this file to universal_router.yaml and customize
# - Sensitive values (API keys, passwords) should use environment variables
# - See docs/architecture/UNIVERSAL_AGENT_ROUTER.md for detailed documentation
