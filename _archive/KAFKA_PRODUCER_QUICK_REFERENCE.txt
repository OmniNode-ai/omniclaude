================================================================================
KAFKA PRODUCER INITIALIZATION QUICK REFERENCE
================================================================================

FOUND: 12 Total Kafka Producer Initialization Points

================================================================================
GLOBAL SINGLETON PRODUCERS (HIGH PRIORITY - Cause "Task was destroyed" Warning)
================================================================================

1. ActionEventPublisher._get_producer_pool()
   File: agents/lib/action_event_publisher.py:153-163
   Pattern: Global variable _kafka_producer
   Status: IMPORTS TRIGGER START() - No cleanup

2. TransformationEventPublisher._get_producer_pool()
   File: agents/lib/transformation_event_publisher.py:161-171
   Pattern: Global variable _kafka_producer
   Status: IMPORTS TRIGGER START() - No cleanup

3. ConfidenceScoring Publisher._get_producer_pool()
   File: agents/lib/confidence_scoring_publisher.py:146-156
   Pattern: Global variable _kafka_producer
   Status: IMPORTS TRIGGER START() - No cleanup

4. ProviderSelectionPublisher._get_producer_pool()
   File: agents/lib/provider_selection_publisher.py:157-167
   Pattern: Global variable _kafka_producer
   Status: IMPORTS TRIGGER START() - No cleanup

================================================================================
INSTANCE PRODUCERS (MEDIUM PRIORITY - Better control if stopped)
================================================================================

5. DatabaseEventClient.start()
   File: agents/lib/database_event_client.py:176-185
   Pattern: self._producer instance variable
   Cleanup: stop() method at line ~190

6. RoutingEventClient.start()
   File: agents/lib/routing_event_client.py:219-228
   Pattern: self._producer instance variable
   Cleanup: stop() method available

7. IntelligenceEventClient.start()
   File: agents/lib/intelligence_event_client.py:186-195
   Pattern: self._producer instance variable
   Cleanup: stop() method available

8. AgentExecutionPublisher.start()
   File: agents/lib/agent_execution_publisher.py:200-209
   Pattern: self._producer instance variable
   Cleanup: stop() method available

9. KafkaCodegenClient.start_producer()
   File: agents/lib/kafka_codegen_client.py:78-86
   Pattern: self._producer instance variable
   Cleanup: stop_producer() method available

10. EventOptimizer._get_producer()
    File: agents/lib/event_optimizer.py:215-222
    Pattern: Pooled instances in self._producer_pool
    Status: Creates new instances, pools them for reuse

11. LoggingEventPublisher.start()
    File: agents/lib/logging_event_publisher.py:236-245
    Pattern: self._producer instance variable
    Cleanup: stop() method available

12. AgentRouterEventService.start()
    File: agents/services/agent_router_event_service.py:628-636
    Pattern: self._producer instance variable
    Cleanup: stop() method available

================================================================================
TEST EXECUTION IMPACT
================================================================================

Which producers activate during tests/test_generation_pipeline.py?

LIKELY TO ACTIVATE (if modules are imported):
  - ActionEventPublisher (global singleton)
  - TransformationEventPublisher (global singleton)
  - ConfidenceScoring Publisher (global singleton)
  - ProviderSelection Publisher (global singleton)

CONDITIONAL (only if explicitly instantiated):
  - DatabaseEventClient
  - RoutingEventClient
  - IntelligenceEventClient
  - AgentExecutionPublisher
  - LoggingEventPublisher

NOT DIRECTLY TRIGGERED:
  - KafkaCodegenClient
  - EventOptimizer
  - AgentRouterEventService

================================================================================
ROOT CAUSE: Global Singleton Pattern
================================================================================

Problem:
  1. Global producers use module-level _kafka_producer variable
  2. When module is imported, producer.start() is called
  3. start() creates background tasks:
     - _sender_routine()
     - _md_synchronizer()
     - _read()
     - Others
  4. These tasks continue after test ends
  5. When event loop closes, tasks are destroyed while pending
  6. Result: "Task was destroyed but it is pending!" warning

Why Not Caught by Mock:
  - conftest.py mocks AIOKafkaProducer class
  - But mock might not catch all import paths
  - Some modules may have already imported real AIOKafkaProducer before mock applies
  - Mock patches after pytest_configure, but conftest.py loads AFTER modules import

================================================================================
CONFTEST MOCK LOCATIONS
================================================================================

1. tests/conftest.py:410-430
   - pytest_configure() function
   - Patches aiokafka.AIOKafkaProducer in sys.modules

2. agents/tests/conftest.py:106-128
   - pytest_configure() function
   - Patches aiokafka.AIOKafkaProducer in sys.modules

Both use same pattern:
  - Store original: config._original_aiokafka_producer = aiokafka.AIOKafkaProducer
  - Replace: aiokafka.AIOKafkaProducer = _get_mock_kafka_producer
  - Patch sys.modules: sys.modules["aiokafka"].AIOKafkaProducer = _get_mock_kafka_producer

================================================================================
SOLUTION CHECKLIST
================================================================================

For Global Singletons (HIGH PRIORITY):

[ ] 1. Change _get_producer_pool() to use lazy initialization
       - Don't call await producer.start() at module import time
       - Only start when first event is published

[ ] 2. Add proper cleanup handler
       import atexit
       def _cleanup():
           if _kafka_producer:
               asyncio.run(_kafka_producer.stop())
       atexit.register(_cleanup)

[ ] 3. Verify mock patches apply before module imports
       - Check pytest plugin load order
       - Ensure pytest_configure runs early

For Instance Producers (MEDIUM PRIORITY):

[ ] 4. Ensure test fixtures call stop()
       @pytest.fixture
       async def some_publisher():
           pub = SomePublisher()
           await pub.start()
           yield pub
           await pub.stop()  # Cleanup

[ ] 5. Add explicit teardown in tests
       try:
           # test code
       finally:
           await publisher.stop()

================================================================================
VERIFICATION COMMANDS
================================================================================

1. Run test and capture warnings:
   python3 -m pytest tests/test_generation_pipeline.py -xvs -W default::DeprecationWarning 2>&1 | grep -A5 "Task was destroyed"

2. Check which modules import producers:
   grep -r "from.*action_event_publisher\|from.*transformation_event\|from.*confidence_scoring\|from.*provider_selection" agents/lib/ tests/

3. Verify mock is applied:
   python3 -c "
   import sys
   sys.path.insert(0, '.')
   import pytest
   # Run pytest collection which triggers conftest
   # Check if AIOKafkaProducer is mocked
   "

4. Trace imports:
   python3 -c "import sys; sys.path.insert(0, '.'); from agents.lib import action_event_publisher; print('Imported successfully')"

================================================================================
FILES FOR MODIFICATION
================================================================================

CRITICAL (Fix pending tasks):
  1. agents/lib/action_event_publisher.py (lines 148-167)
  2. agents/lib/transformation_event_publisher.py (lines 151-175)
  3. agents/lib/confidence_scoring_publisher.py (lines 136-160)
  4. agents/lib/provider_selection_publisher.py (lines 150-175)

IMPORTANT (Ensure cleanup):
  5. agents/lib/database_event_client.py
  6. agents/lib/routing_event_client.py
  7. agents/lib/intelligence_event_client.py
  8. agents/lib/agent_execution_publisher.py
  9. agents/lib/kafka_codegen_client.py
  10. agents/lib/logging_event_publisher.py
  11. agents/services/agent_router_event_service.py

PYTEST FIXTURES:
  12. tests/conftest.py (lines 410-430)
  13. agents/tests/conftest.py (lines 106-128)

================================================================================
NEXT STEPS
================================================================================

1. Add logging to verify which producers are actually created during tests:
   - Add log statement at each "await producer.start()" location
   - Run tests and check which producers get initialized

2. Convert global singletons to lazy loading:
   - Defer start() until first use
   - Add atexit cleanup handler

3. Verify test fixtures properly clean up instances:
   - Add pytest fixture teardown for all instance producers
   - Check stop() is being called

4. Run tests and verify "Task was destroyed" warning is gone:
   python3 -m pytest tests/test_generation_pipeline.py -xvs 2>&1 | grep -i "task was destroyed"

================================================================================
