#!/usr/bin/env python3
"""
Startup script for {{ node_name }}

Initializes node and connects to event bus for service discovery.

Usage:
    python start_node.py                    # Use default configuration
    python start_node.py --config custom.yaml  # Use custom config
    python start_node.py --help             # Show help

Environment Variables:
    KAFKA_BOOTSTRAP_SERVERS: Kafka bootstrap servers (default: omninode-bridge-redpanda:9092)
    SERVICE_NAME: Override service name (default: {{ service_name }})
    LOG_LEVEL: Logging level (default: INFO)
"""

import argparse
import asyncio
import logging
import os
import signal
import sys
from pathlib import Path

# Add parent directory to path for imports
sys.path.insert(0, str(Path(__file__).parent))

from node import {{ node_name }}
from models.model_{{ name_lower }}_config import Model{{ name_pascal }}Config

# Configure logging
LOG_LEVEL = os.getenv("LOG_LEVEL", "INFO")
logging.basicConfig(
    level=getattr(logging, LOG_LEVEL),
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    datefmt="%Y-%m-%d %H:%M:%S",
)
logger = logging.getLogger(__name__)


def parse_args():
    """Parse command line arguments."""
    parser = argparse.ArgumentParser(
        description="Start {{ node_name }} with event bus integration",
        formatter_class=argparse.RawDescriptionHelpFormatter,
    )

    parser.add_argument(
        "--config",
        "-c",
        help="Path to configuration file (YAML or JSON)",
        default=None,
    )

    parser.add_argument(
        "--kafka-servers",
        help="Kafka bootstrap servers (overrides KAFKA_BOOTSTRAP_SERVERS env)",
        default=None,
    )

    parser.add_argument(
        "--skip-event-bus",
        action="store_true",
        help="Skip event bus initialization (standalone mode)",
    )

    return parser.parse_args()


async def main():
    """Main startup routine."""
    args = parse_args()

    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                 {{ node_name }}                                 â•‘
â•‘                 Event Bus Integration Enabled                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)

    # Load configuration
    if args.config:
        # TODO: Load from file
        logger.info(f"Loading config from {args.config}")
        config = Model{{ name_pascal }}Config()
    else:
        # Use defaults
        config = Model{{ name_pascal }}Config()

    # Override Kafka servers if provided
    if args.kafka_servers:
        os.environ["KAFKA_BOOTSTRAP_SERVERS"] = args.kafka_servers

    # Create node instance
    logger.info("Creating node instance...")
    node = {{ node_name }}(config=config)

    # Initialize event bus (unless skipped)
    if not args.skip_event_bus:
        logger.info("Initializing event bus connection...")
        try:
            await node.initialize()
            logger.info("âœ… Node initialized and registered with Consul")
            logger.info(f"   Node ID: {node._node_id}")
            logger.info(f"   Instance ID: {node._instance_id if hasattr(node, '_instance_id') else 'N/A'}")
            logger.info(f"   Service Name: {node._service_name if hasattr(node, '_service_name') else '{{ service_name }}'}")
        except Exception as e:
            logger.error(f"âŒ Event bus initialization failed: {e}")
            logger.info("Continuing in standalone mode...")
    else:
        logger.info("âš ï¸  Running in standalone mode (no event bus)")

    # Setup signal handlers for graceful shutdown
    shutdown_event = asyncio.Event()

    def signal_handler(sig, frame):
        logger.info(f"Received signal {sig}, initiating graceful shutdown...")
        shutdown_event.set()

    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)

    logger.info("ğŸš€ {{ node_name }} is running")
    logger.info("   Press Ctrl+C to shutdown gracefully")

    # Wait for shutdown signal
    await shutdown_event.wait()

    # Graceful shutdown
    logger.info("Shutting down...")
    if hasattr(node, 'shutdown'):
        await node.shutdown()
    logger.info("âœ… Shutdown complete")


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("Interrupted by user")
        sys.exit(0)
    except Exception as e:
        logger.error(f"Fatal error: {e}", exc_info=True)
        sys.exit(1)
