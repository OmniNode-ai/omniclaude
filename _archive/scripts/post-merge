#!/bin/bash
#
# Post-merge hook: Detect and publish merged documentation changes to Kafka
#
# This hook runs after a merge is completed. It detects documentation files
# that were modified during the merge and publishes events to Kafka.
#
# Installation: Copy to .git/hooks/post-merge or use install-hooks.sh

set -e

# Configuration
DOC_PATTERNS='\.md$|\.rst$|\.txt$|docs/.*\.py$'
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
PUBLISHER_SCRIPT="$SCRIPT_DIR/scripts/publish_doc_change.py"

# Get current commit hash
COMMIT_HASH=$(git rev-parse HEAD)

# Get the previous commit before merge (ORIG_HEAD is set by git merge)
if [ -f ".git/ORIG_HEAD" ]; then
    ORIG_HEAD=$(cat .git/ORIG_HEAD)
else
    # Fallback to HEAD~1 if ORIG_HEAD not available
    ORIG_HEAD="HEAD~1"
fi

# Get changed documentation files in this merge
CHANGED_DOCS=$(git diff --name-only --diff-filter=AM "$ORIG_HEAD" HEAD | grep -E "$DOC_PATTERNS" || true)

# If no docs changed, exit early
if [ -z "$CHANGED_DOCS" ]; then
    exit 0
fi

# Count changed files
DOC_COUNT=$(echo "$CHANGED_DOCS" | wc -l | tr -d ' ')

echo "ðŸ”€ Detected $DOC_COUNT documentation file(s) changed in merge $COMMIT_HASH"

# Publish each changed document
while IFS= read -r doc_file; do
    if [ -z "$doc_file" ]; then
        continue
    fi

    # Check if file exists (might have been deleted in merge)
    if [ ! -f "$doc_file" ]; then
        EVENT_TYPE="document_deleted"
    else
        # Determine event type (added vs updated)
        if git diff --name-only --diff-filter=A "$ORIG_HEAD" HEAD | grep -q "^$doc_file$"; then
            EVENT_TYPE="document_added"
        else
            EVENT_TYPE="document_updated"
        fi
    fi

    echo "  â†³ Publishing $EVENT_TYPE: $doc_file"

    # Publish to Kafka (fire and forget with --quiet flag)
    if [ "$EVENT_TYPE" = "document_deleted" ]; then
        # For deleted files, skip (or implement special handling)
        echo "    (skipping deleted file)"
    else
        # Use poetry run to ensure correct Python environment
        (cd "$SCRIPT_DIR" && poetry run python3 "$PUBLISHER_SCRIPT" \
            --file "$doc_file" \
            --event "$EVENT_TYPE" \
            --commit "$COMMIT_HASH" \
            --quiet) &
    fi

done <<< "$CHANGED_DOCS"

# Don't wait for background jobs to complete
exit 0
