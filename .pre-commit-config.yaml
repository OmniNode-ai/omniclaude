# SPDX-FileCopyrightText: 2025 OmniNode.ai Inc.
# SPDX-License-Identifier: MIT
---
# OmniClaude Pre-commit Configuration
# Two-stage validation strategy for optimal developer experience
#
# PERFORMANCE OPTIMIZATION (2026-01):
# ====================================
# Two-stage validation strategy matching omnibase_core patterns:
#
# PRE-COMMIT (target: <15 seconds):
#   - Formatting (ruff format/fix)
#   - Basic file checks (whitespace, large files, merge conflicts)
#   - Quick structural validations
#   - Clean output directory
#
# PRE-PUSH (thorough checks before sharing):
#   - Security checks (bandit, secret detection)
#   - mypy type checking
#   - ONEX validation
#   - Clean root validation
#
# USAGE:
#   pre-commit install                         # Install pre-commit hooks
#   pre-commit install --hook-type pre-push    # Install pre-push hooks
#   pre-commit run --all-files                 # Run all pre-commit hooks
#   pre-commit run --all-files --hook-stage pre-push  # Run pre-push hooks

repos:
  # Fast file checks that can run in parallel
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
        exclude: '\.github/workflows(?:-generated)?/.*\.ya?ml$'
        stages: [pre-commit]
      - id: end-of-file-fixer
        exclude: '\.github/workflows(?:-generated)?/.*\.ya?ml$'
        stages: [pre-commit]
      # check-yaml removed: conflicts with agent YAML files that use custom syntax
      - id: check-added-large-files
        stages: [pre-commit]
      - id: check-merge-conflict
        stages: [pre-commit]
      - id: check-toml
        stages: [pre-commit]

  # Fast Python formatting and linting (staged files only)
  # Order: format -> fix -> check (matches CI behavior)
  # Note: To run on entire codebase, use: uv run ruff check src/ tests/
  - repo: local
    hooks:
      # ============================================================
      # STAGE 1: PRE-COMMIT (fast, target <15 seconds)
      # ============================================================

      - id: check-local-paths
        name: check for local path references
        entry: uv run python -m omnibase_core.validation.validator_local_paths
        language: system
        types: [text]
        exclude: '\.secrets\.baseline$|^docs/.*|^tests/fixtures/.*'
        pass_filenames: true
        stages: [pre-commit]

      - id: clean-output-directory
        name: clean output directory (prevent test artifacts)
        entry: bash -c 'rm -rf output/ && exit 0'
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]

      - id: ruff-format
        name: ruff format (staged files)
        entry: uv run ruff format
        language: system
        types: [python]
        exclude: '\.github/workflows/.*|^\.[^/]*$|^\..*/.*|_archive/.*|src/omniclaude/lib/.*'
        stages: [pre-commit]

      - id: ruff-fix
        name: ruff check --fix (staged files)
        entry: uv run ruff check --fix --exit-non-zero-on-fix
        language: system
        types: [python]
        exclude: '\.github/workflows/.*|^\.[^/]*$|^\..*/.*|_archive/.*|src/omniclaude/lib/.*'
        stages: [pre-commit]

      - id: ruff-check
        name: ruff check (staged files)
        entry: uv run ruff check
        language: system
        types: [python]
        exclude: '\.github/workflows/.*|^\.[^/]*$|^\..*/.*|_archive/.*|src/omniclaude/lib/.*'
        stages: [pre-commit]

      # --------------------------------------------------------------------------
      # detect-secrets baseline regeneration
      # Problem: .secrets.baseline stores line numbers. When new jobs are added to
      # CI workflows, all downstream line numbers shift, causing false-positive
      # "Secret Detection" CI failures on every such PR (OMN-2625).
      # Solution: Regenerate the baseline before each commit so committed line
      # numbers always reflect the current codebase state. CI comparison then
      # finds zero delta because baseline was already updated.
      # Uses the same --exclude-files patterns as the CI detect-secrets job.
      # --------------------------------------------------------------------------
      - id: detect-secrets-update
        name: regenerate .secrets.baseline (prevent line-shift false positives)
        entry: bash -c '
          detect-secrets scan \
            --baseline .secrets.baseline \
            --exclude-files "\.lock$" \
            --exclude-files "\.env\.example$" \
            --exclude-files "bandit-report\.json$" \
            --exclude-files "^tests/" \
            --exclude-files "security-report\.json$" \
          && git add .secrets.baseline'
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]

      # --------------------------------------------------------------------------
      # Migration Freeze Check - Block new migrations during DB-per-repo refactor
      # Scope: Only triggers when migration files or .migration_freeze change
      # Purpose: Enforces schema freeze (OMN-2055) while .migration_freeze exists
      # Note: Checks filesystem for freeze file, so removing .migration_freeze in
      #       the same commit as adding a migration intentionally lifts the freeze.
      # --------------------------------------------------------------------------
      - id: migration-freeze-check
        name: migration freeze check
        entry: ./scripts/check_migration_freeze.sh
        language: system
        pass_filenames: false
        files: ^(sql/migrations/|\.migration_freeze)
        stages: [pre-commit]

      # ============================================================
      # STAGE 2: PRE-PUSH (thorough checks before sharing)
      # ============================================================

      - id: bandit-security
        name: bandit security scan
        entry: uv run bandit -r -c .bandit
        language: system
        types: [python]
        exclude: '^\.[^/]*$|^\..*/.*|_archive/.*|tests/.*|lib/.*'
        pass_filenames: true
        stages: [pre-push]

      - id: mypy-type-check
        name: mypy (type checking - match CI)
        # SCOPE: Currently limited to hooks/ and config/ (strict, well-typed modules)
        # TODO(post-Beta): After lib/ deletion, expand to full src/omniclaude/:
        #   entry: bash -c 'uv run mypy src/omniclaude/ --ignore-missing-imports'
        # Exclusion: lib/ contains legacy code that will be deleted post-Beta
        entry: bash -c 'uv run mypy src/omniclaude/hooks/ src/omniclaude/config/ --ignore-missing-imports'
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-push]

      - id: pyright-type-check
        name: pyright (type checking - complements mypy)
        # Pyright provides complementary type checking to mypy, catching different error categories.
        # Uses pyrightconfig.json for configuration (basic mode with incremental strictness).
        entry: bash -c 'uv run pyright src/omniclaude'
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-push]

      - id: onex-validate
        name: ONEX validation
        entry: uv run python scripts/validate_onex.py
        language: system
        pass_filenames: false
        always_run: true
        # Exclude: hidden files, _archive, tests, and lib/ (legacy code, post-Beta deletion)
        stages: [pre-push]

      - id: validate-clean-root
        name: Validate clean root directory
        entry: bash scripts/validate-clean-root.sh
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-push]

      - id: validate-secrets
        name: ONEX Secret Detection
        entry: uv run python scripts/validation/validate_secrets.py
        language: system
        pass_filenames: true
        types: [python]
        exclude: '^\.[^/]*$|^\..*/.*|_archive/.*|tests/.*'
        stages: [pre-push]

      - id: validate-no-duplicate-models
        name: No duplicate model filenames
        entry: uv run python scripts/validation/validate_no_duplicate_models.py
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-push]

      - id: validate-pydantic-patterns
        name: Pydantic pattern validation
        entry: uv run python scripts/validation/validate_pydantic_patterns.py
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-push]

      - id: validate-single-class-per-file
        name: Single class per file
        entry: uv run python scripts/validation/validate_single_class_per_file.py --quiet
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-push]

      - id: validate-enum-governance
        name: ONEX Enum Governance Validation
        entry: uv run python scripts/validation/validate_enum_governance.py --quiet
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-push]

      - id: validate-exports
        name: Validate __all__ exports
        entry: uv run python scripts/validation/validate_exports.py
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-push]

      - id: no-internal-ips
        name: Block hardcoded internal IPs
        language: system
        entry: >
          bash -c 'grep -rInE
          --include="*.py" --include="*.sh" --include="*.yml"
          --include="*.yaml" --include="*.toml" --include="*.md"
          "(192\.168\.|10\.(0|1|2)\.|172\.(1[6-9]|2[0-9]|3[0-1])\.)"
          src/ tests/ docs/ .github/ plugins/ 2>/dev/null
          | grep -v "onex-allow-internal-ip"
          && echo "ERROR: hardcoded internal IP found (add # onex-allow-internal-ip to suppress)" && exit 1 || exit 0'
        pass_filenames: false
        stages: [pre-commit]

# Configuration
default_install_hook_types: [pre-commit, pre-push]
default_stages: [pre-commit]
fail_fast: false

ci:
  autofix_commit_msg: |
    [pre-commit.ci] auto fixes from pre-commit.com hooks

    for more information, see https://pre-commit.ci
  autofix_prs: true
  autoupdate_branch: ''
  autoupdate_commit_msg: '[pre-commit.ci] pre-commit autoupdate'
  autoupdate_schedule: weekly
  skip: []
  submodules: false
