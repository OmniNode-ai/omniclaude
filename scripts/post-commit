#!/bin/bash
#
# Post-commit hook: Detect and publish documentation changes to Kafka
#
# This hook runs after a commit is created. It detects changes to documentation
# files and publishes events to Kafka for downstream processing.
#
# Installation: Copy to .git/hooks/post-commit or use install-hooks.sh

set -e

# Configuration
DOC_PATTERNS='\.md$|\.rst$|\.txt$|docs/.*\.py$'
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
PUBLISHER_SCRIPT="$SCRIPT_DIR/scripts/publish_doc_change.py"

# Get current commit hash
COMMIT_HASH=$(git rev-parse HEAD)

# Get changed documentation files in this commit
CHANGED_DOCS=$(git diff-tree --no-commit-id --name-only --diff-filter=AM -r HEAD | grep -E "$DOC_PATTERNS" || true)

# If no docs changed, exit early
if [ -z "$CHANGED_DOCS" ]; then
    exit 0
fi

# Count changed files
DOC_COUNT=$(echo "$CHANGED_DOCS" | wc -l | tr -d ' ')

echo "üìù Detected $DOC_COUNT documentation file(s) changed in commit $COMMIT_HASH"

# Publish each changed document
while IFS= read -r doc_file; do
    if [ -z "$doc_file" ]; then
        continue
    fi

    # Determine event type (added vs updated)
    if git diff-tree --no-commit-id --name-only --diff-filter=A -r HEAD | grep -q "^$doc_file$"; then
        EVENT_TYPE="document_added"
    else
        EVENT_TYPE="document_updated"
    fi

    echo "  ‚Ü≥ Publishing $EVENT_TYPE: $doc_file"

    # Publish to Kafka (fire and forget with --quiet flag)
    # Use poetry run to ensure correct Python environment
    (cd "$SCRIPT_DIR" && poetry run python3 "$PUBLISHER_SCRIPT" \
        --file "$doc_file" \
        --event "$EVENT_TYPE" \
        --commit "$COMMIT_HASH" \
        --quiet) &

done <<< "$CHANGED_DOCS"

# Don't wait for background jobs to complete
exit 0
