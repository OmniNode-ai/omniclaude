HOOKS CONFIGURATION AUDIT
Generated: 2025-11-11
Working Directory: ~/.claude/hooks

======================================================================
EXECUTIVE SUMMARY
======================================================================

Total Hook Files Analyzed: 67+
- Shell Scripts: 13
- Python Support Files: 40+
- Test Files: 14

Configuration Approaches Found:
- ✅ Pydantic Settings: 6 files (9%)
- ⚠️ Legacy os.getenv(): 33+ files (49%)
- ⚠️ Shell env vars: 13 files (19%)
- ✓ No config needed: 15+ files (22%)

======================================================================
✅ USING PYDANTIC SETTINGS (Good - Modern Approach)
======================================================================

1. pattern_tracker.py
   - Uses: from config import settings
   - Status: ✅ EXCELLENT
   - Notes: Fully migrated to type-safe configuration

2. detection_failure_tracker.py
   - Uses: from config import settings + some os.getenv()
   - Status: ✅ HYBRID (mostly good)
   - Notes: Uses settings.get_effective_postgres_password() but still has some os.getenv for POSTGRES_HOST, POSTGRES_PORT, etc.
   - Priority: Medium (complete migration to settings object)

3. phase4_api_client.py
   - Uses: from config import settings
   - Status: ✅ EXCELLENT
   - Notes: Fully migrated to type-safe configuration

4. pattern_tracker_sync.py
   - Uses: from config import settings
   - Status: ✅ EXCELLENT
   - Notes: Fully migrated to type-safe configuration

5. resilience.py
   - Uses: from config import settings
   - Status: ✅ EXCELLENT
   - Notes: Fully migrated to type-safe configuration

6. route_via_events_wrapper.py
   - Uses: from config import settings (via routing_event_client)
   - Status: ✅ EXCELLENT
   - Notes: Carefully handles sys.path to avoid config module conflicts

======================================================================
⚠️ USING LEGACY APPROACHES (Needs Migration)
======================================================================

SHELL SCRIPTS (Environment Variables)
----------------------------------------------------------------------

1. user-prompt-submit.sh
   - Uses: Sources .env, direct env vars
   - Variables: ARCHON_INTELLIGENCE_URL, KAFKA_BOOTSTRAP_SERVERS, KAFKA_BROKERS, DB_PASSWORD, POSTGRES_PASSWORD
   - Status: ⚠️ LEGACY
   - Priority: HIGH (main hook, frequently executed)
   - Migration Path: Source .env is fine, but consider wrapper script that validates config via Pydantic

2. pre-tool-use-quality.sh
   - Uses: Environment variables
   - Variables: KAFKA_BROKERS, DB_PASSWORD
   - Status: ⚠️ LEGACY
   - Priority: HIGH (quality enforcement)
   - Migration Path: Wrapper script with config validation

3. post-tool-use-quality.sh
   - Uses: Environment variables
   - Variables: KAFKA_BROKERS, DB_PASSWORD
   - Status: ⚠️ LEGACY
   - Priority: HIGH (quality enforcement)
   - Migration Path: Wrapper script with config validation

4. session-start.sh
   - Uses: Environment variables
   - Status: ⚠️ LEGACY
   - Priority: MEDIUM (less frequent)

5. session-end.sh
   - Uses: Environment variables
   - Status: ⚠️ LEGACY
   - Priority: MEDIUM (less frequent)

6. stop.sh
   - Uses: Environment variables
   - Status: ⚠️ LEGACY
   - Priority: MEDIUM (less frequent)

7. setup-symlinks.sh
   - Uses: Environment variables
   - Status: ⚠️ LEGACY
   - Priority: LOW (setup only)

8-13. Test Scripts (test_*.sh)
   - Status: ⚠️ LEGACY
   - Priority: LOW (testing only)

PYTHON SUPPORT FILES (os.getenv)
----------------------------------------------------------------------

HIGH PRIORITY (Database/Infrastructure):

14. hook_event_logger.py
    - Uses: os.getenv("DB_PASSWORD"), os.getenv("POSTGRES_HOST"), os.getenv("POSTGRES_PORT"), os.getenv("POSTGRES_DB"), os.getenv("POSTGRES_USER")
    - Status: ⚠️ CRITICAL LEGACY
    - Priority: CRITICAL (used everywhere for DB logging)
    - Migration Path: Replace with settings.get_postgres_dsn() or individual settings properties
    - Impact: HIGH (used by many other hooks)

15. hook_event_processor.py
    - Uses: os.getenv("POSTGRES_PASSWORD"), os.getenv("DB_PASSWORD"), os.getenv("POSTGRES_HOST"), os.getenv("POSTGRES_PORT"), os.getenv("POSTGRES_DB"), os.getenv("POSTGRES_USER")
    - Status: ⚠️ CRITICAL LEGACY
    - Priority: CRITICAL (background service)
    - Migration Path: Replace with settings properties
    - Impact: HIGH (service reliability)

16. session_intelligence.py
    - Uses: HookEventLogger (which uses os.getenv)
    - Status: ⚠️ INDIRECT LEGACY
    - Priority: HIGH (depends on hook_event_logger)
    - Migration Path: Will be fixed when hook_event_logger is migrated

MEDIUM PRIORITY (Agent/Routing):

17. agent_invoker.py
    - Uses: os.getenv("OMNICLAUDE_AGENTS_PATH")
    - Status: ⚠️ LEGACY
    - Priority: MEDIUM
    - Migration Path: Add to settings.py as agent_framework_path

18. archon_intelligence.py
    - Uses: os.getenv("ARCHON_MCP_URL", "http://localhost:8051")
    - Status: ⚠️ LEGACY
    - Priority: MEDIUM
    - Migration Path: Use settings.archon_mcp_url (already exists!)

19. hybrid_agent_selector.py
    - Uses: os.getenv("ENABLE_AI_AGENT_SELECTION"), os.getenv("AI_AGENT_CONFIDENCE_THRESHOLD"), os.getenv("AI_MODEL_PREFERENCE"), os.getenv("AI_SELECTION_TIMEOUT_MS")
    - Status: ⚠️ LEGACY
    - Priority: MEDIUM
    - Migration Path: Add AI selection config to settings.py

20. quality_enforcer.py
    - Uses: os.getenv for multiple config options (PERFORMANCE_BUDGET_SECONDS, ENFORCEMENT_MODE, etc.)
    - Status: ⚠️ LEGACY
    - Priority: MEDIUM (quality enforcement)
    - Migration Path: Add quality config section to settings.py

LOW PRIORITY (Utilities/Less Frequent):

21. manifest_loader.py
    - Uses: os.environ.get("PROJECT_PATH"), os.environ.get("CORRELATION_ID"), os.environ.get("AGENT_NAME")
    - Status: ⚠️ LEGACY
    - Priority: LOW (mostly runtime/dynamic values)
    - Migration Path: PROJECT_PATH could use settings, others are runtime

22-33. Other lib files:
    - agent_summary_banner.py
    - hook_event_adapter.py
    - publish_intelligence_request.py
    - workflow_executor.py
    - Various test files
    - Status: ⚠️ LEGACY
    - Priority: LOW to MEDIUM

======================================================================
✓ NO CONFIGURATION NEEDED
======================================================================

Test files without external configuration:
- test_agent_detection.py
- test_ast_corrector.py
- test_event_memory_store.py
- test_hook_lifecycle.py
- test_integration.py
- test_naming_validator.py
- Various __init__.py files

======================================================================
MIGRATION PRIORITY MATRIX
======================================================================

CRITICAL (Fix Immediately):
1. hook_event_logger.py - Used everywhere, database credentials
2. hook_event_processor.py - Background service, database credentials

HIGH (Fix in Phase 1):
3. user-prompt-submit.sh - Main hook, frequent execution
4. pre-tool-use-quality.sh - Quality enforcement
5. post-tool-use-quality.sh - Quality enforcement
6. session_intelligence.py - Depends on hook_event_logger

MEDIUM (Fix in Phase 2):
7. archon_intelligence.py - Service URL (setting already exists!)
8. agent_invoker.py - Agent path
9. hybrid_agent_selector.py - AI selection config
10. quality_enforcer.py - Quality config

LOW (Fix in Phase 3):
11. Shell test scripts
12. Utility/helper scripts
13. manifest_loader.py (partial - some vars are runtime)

======================================================================
RECOMMENDED MIGRATION STRATEGY
======================================================================

Phase 1: Critical Database Infrastructure (Week 1)
- Migrate hook_event_logger.py to use settings
- Migrate hook_event_processor.py to use settings
- Test thoroughly (database logging is critical)

Phase 2: Main Hooks (Week 2)
- Add validation wrapper for shell hooks
- Migrate archon_intelligence.py (setting exists!)
- Migrate session_intelligence.py

Phase 3: Agent/Quality (Week 3)
- Add AI selection config to settings.py
- Migrate hybrid_agent_selector.py
- Add quality config to settings.py
- Migrate quality_enforcer.py

Phase 4: Cleanup (Week 4)
- Migrate remaining utilities
- Update test scripts
- Documentation updates

======================================================================
CONFIGURATION GAPS TO ADD TO settings.py
======================================================================

Missing from settings.py (need to add):
1. OMNICLAUDE_AGENTS_PATH → agent_framework_path
2. ENABLE_AI_AGENT_SELECTION → enable_ai_agent_selection
3. AI_AGENT_CONFIDENCE_THRESHOLD → ai_agent_confidence_threshold
4. AI_MODEL_PREFERENCE → ai_model_preference
5. AI_SELECTION_TIMEOUT_MS → ai_selection_timeout_ms
6. PERFORMANCE_BUDGET_SECONDS → performance_budget_seconds
7. ENFORCEMENT_MODE → enforcement_mode

Already exists in settings.py (just needs migration):
1. archon_mcp_url ✅ (archon_intelligence.py can use immediately)
2. postgres_* ✅ (all database fields exist)
3. kafka_bootstrap_servers ✅

======================================================================
SUMMARY STATISTICS
======================================================================

Total Files: 67+
Using Pydantic Settings: 6 (9%)
Needs Migration: 46 (69%)
No Config Needed: 15 (22%)

Critical Priority: 2 files
High Priority: 4 files
Medium Priority: 4 files
Low Priority: 36+ files

Estimated Migration Effort:
- Phase 1 (Critical): 2-3 days
- Phase 2 (High): 3-4 days
- Phase 3 (Medium): 3-4 days
- Phase 4 (Low): 2-3 days
Total: 10-14 days (2-3 weeks)

======================================================================
NEXT STEPS
======================================================================

1. Review this audit with team
2. Prioritize critical migrations (hook_event_logger.py first!)
3. Add missing config fields to settings.py
4. Create migration PRs by phase
5. Update documentation
6. Add deprecation warnings for os.getenv usage

======================================================================
END OF AUDIT
======================================================================
