---
# ONEX Contract v2.0
contract_version: "2.0"
node_type: "compute"
node_name: "STFQualityCompute"
description: "Calculate 5-dimension STF quality score with caching for performance"

# omnibase_core Models Used
models:
  from_omnibase_core:
    - "omnibase_core.errors.model_onex_error.ModelOnexError"
    - "omnibase_core.errors.error_codes.EnumCoreErrorCode"

# Input Contract
input:
  stf_code:
    type: "string"
    required: true
    description: "Python code of the STF to evaluate"

  stf_hash:
    type: "string"
    required: true
    description: "SHA-256 hash for cache key"

  stf_metadata:
    type: "object"
    required: true
    properties:
      has_docstring:
        type: "boolean"
        required: true
      has_type_hints:
        type: "boolean"
        required: true
      has_error_handling:
        type: "boolean"
        required: true
      has_tests:
        type: "boolean"
        required: false
        default: false
      lines_of_code:
        type: "integer"
        required: false
      cyclomatic_complexity:
        type: "integer"
        required: false

  onex_compliance_check:
    type: "boolean"
    required: false
    default: true
    description: "Whether to check ONEX compliance"

# Output Contract
output:
  quality_score:
    type: "float"
    required: true
    min: 0.0
    max: 1.0
    description: "Composite quality score (weighted average)"

  dimension_scores:
    type: "object"
    required: true
    properties:
      completeness:
        type: "float"
        min: 0.0
        max: 1.0
        description: "Code completeness (has main logic, handles edge cases)"
      documentation:
        type: "float"
        min: 0.0
        max: 1.0
        description: "Documentation quality (docstring, comments, type hints)"
      onex_compliance:
        type: "float"
        min: 0.0
        max: 1.0
        description: "ONEX compliance (follows patterns, uses contracts)"
      metadata:
        type: "float"
        min: 0.0
        max: 1.0
        description: "Metadata quality (has version, author, description)"
      complexity:
        type: "float"
        min: 0.0
        max: 1.0
        description: "Complexity score (inverse - simpler is better)"

  composite_calculation:
    type: "object"
    required: true
    properties:
      weights:
        type: "object"
        properties:
          completeness: 0.30
          documentation: 0.25
          onex_compliance: 0.20
          metadata: 0.15
          complexity: 0.10
      formula:
        type: "string"
        value: "sum(dimension * weight for each dimension)"

  cache_hit:
    type: "boolean"
    required: true
    description: "Whether this result came from cache"

  computation_time_ms:
    type: "float"
    required: true

  timestamp:
    type: "datetime"
    required: true

# Pure Function Properties
pure_function: true  # No side effects
deterministic: true  # Same input â†’ same output
cacheable: true
cache_key: "stf_hash"
cache_ttl_seconds: 3600  # 1 hour

# Performance Targets
performance:
  target_latency_ms: 50
  max_latency_ms: 100
  cache_hit_rate_target: 0.60

# ONEX Compliance
onex_compliance:
  base_class: "omnibase_core.core.infrastructure_service_bases.NodeComputeService"
  method_signature: "async def execute_compute(self, contract: ModelContractCompute) -> ModelComputeOutput"
  side_effects: false
  idempotent: true
  thread_safe: false  # Has mutable cache state

# Quality Scoring Algorithm
algorithm:
  completeness:
    formula: |
      score = 0.0
      if has_main_function: score += 0.4
      if has_error_handling: score += 0.3
      if handles_edge_cases: score += 0.3
      return min(1.0, score)

  documentation:
    formula: |
      score = 0.0
      if has_docstring: score += 0.4
      if has_type_hints: score += 0.3
      if has_inline_comments: score += 0.3
      return min(1.0, score)

  onex_compliance:
    formula: |
      score = 0.0
      if uses_pydantic_models: score += 0.3
      if follows_naming_convention: score += 0.3
      if has_contract_validation: score += 0.4
      return min(1.0, score)

  metadata:
    formula: |
      score = 0.0
      if has_version: score += 0.3
      if has_description: score += 0.4
      if has_author: score += 0.3
      return min(1.0, score)

  complexity:
    formula: |
      # Lower complexity is better
      if cyclomatic_complexity <= 5: return 1.0
      if cyclomatic_complexity <= 10: return 0.8
      if cyclomatic_complexity <= 15: return 0.6
      if cyclomatic_complexity <= 20: return 0.4
      return 0.2

# Testing Requirements
testing:
  unit_tests:
    - "Test with perfect STF (all dimensions = 1.0)"
    - "Test with minimal STF (all dimensions = 0.0)"
    - "Test with partial STF (mixed dimensions)"
    - "Test cache hit (same STF hash twice)"
    - "Test cache miss (different STF hash)"
    - "Test composite score calculation"

  fixtures:
    - name: "perfect_stf"
      quality_score: 1.0
      has_docstring: true
      has_type_hints: true
      has_error_handling: true
      cyclomatic_complexity: 3

    - name: "minimal_stf"
      quality_score: ~0.3
      has_docstring: false
      has_type_hints: false
      has_error_handling: false
      cyclomatic_complexity: 20
