# SPDX-FileCopyrightText: 2025 OmniNode.ai Inc.
# SPDX-License-Identifier: MIT
---
# ONEX Contract v2.0
contract_version: "2.0"
node_type: "effect"
node_name: "DebugSTFStorageEffect"
description: "Store and retrieve Specific Transformation Functions (STFs) in PostgreSQL with quality metrics"

# Associated Documents (ONEX Linked Documents Pattern)
associated_documents:
  architecture:
    - path: "docs/analysis/DEBUG_REWARDS_CLARIFICATION_ANALYSIS.md"
      purpose: "STF registry design and requirements"

  implementation:
    - path: "omniclaude/debug_loop/node_debug_stf_storage_effect.py"
      purpose: "Effect node implementation for STF storage"
    - path: "migrations/001_debug_loop_core_schema.sql"
      purpose: "debug_transform_functions table schema"

  testing:
    - path: "omniclaude/debug_loop/test_debug_stf_storage_effect.py"
      purpose: "Unit tests for STF storage operations"

  implementation_plans:
    - path: "docs/planning/DEBUG_LOOP_IMPLEMENTATION_PLAN.md"
      section: "Week 2: STF Registry & Discovery"
      relationship: "implementation_guide"
      description: "Storage node for STF registry (Days 6-10)"

  related_contracts:
    - path: "contracts/debug_loop/debug_loop_orchestrator.yaml"
      relationship: "orchestrated_by"
      description: "Orchestrated by DebugLoopOrchestrator workflow"
    - path: "contracts/debug_loop/debug_stf_extractor_compute.yaml"
      relationship: "depends_on"
      description: "Receives extracted STF code from extractor"
    - path: "contracts/debug_loop/stf_quality_compute.yaml"
      relationship: "depends_on"
      description: "Receives quality scores for storage"
    - path: "contracts/debug_loop/stf_hash_compute.yaml"
      relationship: "depends_on"
      description: "Receives STF hash for deduplication"

  external_systems:
    - name: "PostgreSQL (omninode_bridge)"
      host: "192.168.86.200:5436"
      table: "debug_transform_functions"
      relationship: "data_persistence"
      description: "Stores STFs with quality metrics and usage tracking"

  configuration:
    - path: "config/settings.py"
      relationship: "database_config"
      description: "PostgreSQL connection settings (type-safe)"
    - path: ".env"
      relationship: "credentials"
      description: "POSTGRES_HOST, POSTGRES_PORT, POSTGRES_PASSWORD"

  documentation:
    - path: "CLAUDE.md"
      section: "Environment Configuration"
      relationship: "infrastructure_guide"
      description: "Database connection and credential management"

# omnibase_core Models Used
models:
  from_omnibase_core:
    - "omnibase_core.errors.model_onex_error.ModelOnexError"
    - "omnibase_core.errors.error_codes.EnumCoreErrorCode"
    - "omnibase_core.models.common.model_error_context.ModelErrorContext"

# Input Contract
input:
  operation:
    type: "enum"
    values: ["store", "retrieve", "search", "update_usage", "update_quality"]
    required: true
    description: "Operation to perform on STF storage"

  # For store operation
  stf_data:
    type: "object"
    required: false
    required_for: ["store"]
    properties:
      stf_name:
        type: "string"
        required: true
      stf_code:
        type: "string"
        required: true
      stf_hash:
        type: "string"
        required: true
        description: "SHA-256 hash of normalized STF code"
      stf_description:
        type: "string"
        required: false
      problem_category:
        type: "string"
        required: false
      problem_signature:
        type: "string"
        required: false
      quality_score:
        type: "float"
        required: false
        min: 0.0
        max: 1.0
      source_execution_id:
        type: "string"
        format: "uuid"
        required: false
      source_correlation_id:
        type: "string"
        format: "uuid"
        required: false
      contributor_agent_name:
        type: "string"
        required: false

  # For retrieve operation
  stf_id:
    type: "string"
    format: "uuid"
    required: false
    required_for: ["retrieve", "update_usage", "update_quality"]

  # For search operation
  search_criteria:
    type: "object"
    required: false
    required_for: ["search"]
    properties:
      problem_signature:
        type: "string"
        required: false
      problem_category:
        type: "string"
        required: false
      min_quality:
        type: "float"
        required: false
        default: 0.7
      approval_status:
        type: "string"
        enum: ["pending", "approved", "rejected"]
        required: false
        default: "approved"
      limit:
        type: "integer"
        required: false
        default: 10
        min: 1
        max: 100

  # For update_quality operation
  quality_scores:
    type: "object"
    required: false
    required_for: ["update_quality"]
    properties:
      quality_score:
        type: "float"
        min: 0.0
        max: 1.0
      completeness_score:
        type: "float"
        min: 0.0
        max: 1.0
      documentation_score:
        type: "float"
        min: 0.0
        max: 1.0
      onex_compliance_score:
        type: "float"
        min: 0.0
        max: 1.0
      metadata_score:
        type: "float"
        min: 0.0
        max: 1.0
      complexity_score:
        type: "float"
        min: 0.0
        max: 1.0

# Output Contract
output:
  success:
    type: "boolean"
    required: true

  operation:
    type: "string"
    required: true

  # For store/retrieve/update operations
  stf_id:
    type: "string"
    format: "uuid"
    required: false
    required_for: ["store", "retrieve", "update_usage", "update_quality"]

  stf_data:
    type: "object"
    required: false
    required_for: ["retrieve"]
    properties:
      stf_name:
        type: "string"
        required: true
      stf_code:
        type: "string"
        required: true
      stf_hash:
        type: "string"
        required: true
      stf_description:
        type: "string"
        required: false
      problem_category:
        type: "string"
        required: false
      quality_score:
        type: "float"
        required: false
      usage_count:
        type: "integer"
        required: true
      success_count:
        type: "integer"
        required: true
      approval_status:
        type: "string"
        required: true
      created_at:
        type: "datetime"
        required: true
      last_used_at:
        type: "datetime"
        required: false

  # For search operation
  search_results:
    type: "array"
    required: false
    items:
      type: "object"
      properties:
        stf_id:
          type: "string"
        stf_name:
          type: "string"
        stf_description:
          type: "string"
        problem_category:
          type: "string"
        quality_score:
          type: "float"
        usage_count:
          type: "integer"
        success_rate:
          type: "float"
    required_for: ["search"]

  result_count:
    type: "integer"
    required: false
    required_for: ["search"]

  # Error information
  error:
    type: "string"
    required: false

  timestamp:
    type: "datetime"
    required: true

# Error Handling
error_handling:
  - error_code: "DB_CONNECTION_ERROR"
    description: "Failed to connect to PostgreSQL"
    retry: true
    max_retries: 3

  - error_code: "DUPLICATE_STF_ERROR"
    description: "STF with same hash already exists"
    retry: false

  - error_code: "STF_NOT_FOUND"
    description: "STF with given ID not found"
    retry: false

  - error_code: "VALIDATION_ERROR"
    description: "Invalid input data"
    retry: false

# Dependencies (from ModelONEXContainer)
dependencies:
  protocols:
    - "IDatabaseProtocol"  # PostgreSQL connection protocol from omnibase_spi

  mixins:
    - "RetryMixin"  # Automatic retry logic
    - "CircuitBreakerMixin"  # Circuit breaker pattern
    - "ObservabilityMixin"  # Logging and tracing

# Performance Targets
performance:
  target_latency_ms: 50
  max_latency_ms: 200
  target_throughput_rps: 100

# ONEX Compliance
onex_compliance:
  base_class: "omnibase_core.core.infrastructure_service_bases.NodeEffectService"
  method_signature: "async def execute_effect(self, contract: ModelContractEffect) -> ModelEffectOutput"
  side_effects: true
  idempotent: false  # Database writes are not idempotent
  thread_safe: false  # Uses connection pool

# Testing Requirements
testing:
  unit_tests:
    - "Test store operation with valid STF"
    - "Test retrieve operation with existing STF"
    - "Test search with quality filter"
    - "Test duplicate STF handling"
    - "Test update_usage increments counter"

  integration_tests:
    - "Test with mock database protocol"
    - "Test with real PostgreSQL (E2E)"
    - "Test retry logic on connection failure"
    - "Test circuit breaker pattern"

  mocks:
    - "MockDatabaseProtocol for unit tests"
    - "In-memory STF storage for fast tests"
