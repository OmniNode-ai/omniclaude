# SPDX-FileCopyrightText: 2025 OmniNode.ai Inc.
# SPDX-License-Identifier: MIT
---
# ONEX Contract v2.0
contract_version: "2.0"
node_type: "reducer"
node_name: "GoldenStateManagerReducer"
description: "Manage golden state nominations and approvals using FSM with intent-based persistence"

# Associated Documents (ONEX Linked Documents Pattern)
associated_documents:
  implementation_plans:
    - path: "docs/planning/DEBUG_LOOP_IMPLEMENTATION_PLAN.md"
      section: "Week 4: Error→Success Mapping & Golden States"
      relationship: "implementation_guide"
      description: "Golden state workflow and registry (Days 17-18)"

  architecture:
    - path: "docs/analysis/DEBUG_REWARDS_CLARIFICATION_ANALYSIS.md"
      purpose: "Golden state FSM design and transitions"

  implementation:
    - path: "omniclaude/debug_loop/node_golden_state_manager_reducer.py"
      purpose: "Reducer node for golden state management (to be implemented)"
    - path: "migrations/001_debug_loop_core_schema.sql"
      purpose: "debug_golden_states table schema"

  related_contracts:
    - path: "contracts/debug_loop/debug_loop_orchestrator.yaml"
      relationship: "orchestrated_by"
      description: "Orchestrated by DebugLoopOrchestrator workflow"
    - path: "contracts/debug_loop/stf_quality_compute.yaml"
      relationship: "depends_on"
      description: "Uses quality scores for auto-approval threshold"

  external_systems:
    - name: "PostgreSQL (omnibase_infra)"
      host: "localhost:5436"
      table: "debug_golden_states"
      relationship: "state_persistence"
      description: "Stores golden state nominations and approvals"

  algorithms:
    - name: "FSM State Machine"
      states: ["none", "nominated", "approved", "rejected"]
      transitions: ["nominate", "approve", "reject", "record_reuse", "update_quality"]
      relationship: "fsm_definition"
      description: "Pure FSM with intent-based persistence for golden states"
    - name: "Auto-Approval"
      threshold: 0.9
      relationship: "approval_algorithm"
      description: "Automatic approval for quality scores >= 0.9"
    - name: "Reward Calculation (Part 2)"
      formula: "base_reward * quality_multiplier + reuse_bonus"
      relationship: "reward_algorithm"
      description: "Token reward calculation for Part 2 integration"

  configuration:
    - path: "config/settings.py"
      relationship: "database_config"
      description: "PostgreSQL connection and approval thresholds"

  documentation:
    - path: "CLAUDE.md"
      section: "Agent Observability & Traceability"
      relationship: "observability_guide"
      description: "Golden state tracking and reuse monitoring"
    - path: "docs/planning/DEBUG_LOOP_IMPLEMENTATION_PLAN.md"
      section: "Part 2: Token Economy Integration"
      relationship: "future_integration"
      description: "Token rewards for golden state contributions (Part 2)"

# omnibase_core Models Used
models:
  from_omnibase_core:
    - "omnibase_core.errors.model_onex_error.ModelOnexError"
    - "omnibase_core.errors.error_codes.EnumCoreErrorCode"
    - "omnibase_core.models.model_intent.ModelIntent"
    - "omnibase_core.models.model_intent.EnumIntentType"

# Input Contract
input:
  # Current state
  current_state:
    type: "object"
    required: false
    default: null
    description: "Current golden state (null if nomination)"
    properties:
      golden_state_id:
        type: "string"
        format: "uuid"
      execution_attempt_id:
        type: "string"
        format: "uuid"
      problem_description:
        type: "string"
      solution_summary:
        type: "string"
      quality_score:
        type: "float"
      reuse_count:
        type: "integer"
      approval_status:
        type: "string"
        enum: ["nominated", "approved", "rejected"]

  # Action
  action:
    type: "enum"
    values: ["nominate", "approve", "reject", "record_reuse", "update_quality"]
    required: true

  # Payload
  payload:
    type: "object"
    required: true
    properties:
      # For nominate action
      execution_attempt_id:
        type: "string"
        format: "uuid"
        required_for_action: ["nominate"]
      correlation_id:
        type: "string"
        format: "uuid"
        required_for_action: ["nominate"]
      problem_description:
        type: "string"
        required_for_action: ["nominate"]
      solution_summary:
        type: "string"
        required_for_action: ["nominate"]
      quality_score:
        type: "float"
        required_for_action: ["nominate"]
        min: 0.0
        max: 1.0
      stf_ids:
        type: "array"
        items:
          type: "string"
        required: false
      # For approve/reject actions
      approved_by:
        type: "string"
        required_for_action: ["approve"]
      approval_notes:
        type: "string"
        required: false
      # For record_reuse action
      reused_by_execution_id:
        type: "string"
        format: "uuid"
        required_for_action: ["record_reuse"]
      # For update_quality action
      new_quality_score:
        type: "float"
        required_for_action: ["update_quality"]
        min: 0.0
        max: 1.0

# Output Contract
output:
  # New state
  new_state:
    type: "object"
    required: true
    properties:
      golden_state_id:
        type: "string"
        format: "uuid"
      execution_attempt_id:
        type: "string"
        format: "uuid"
      problem_description:
        type: "string"
      solution_summary:
        type: "string"
      quality_score:
        type: "float"
        min: 0.0
        max: 1.0
      reuse_count:
        type: "integer"
      approval_status:
        type: "string"
        enum: ["nominated", "approved", "rejected"]
      approved_by:
        type: "string"
      approved_at:
        type: "datetime"

  # Intents
  intents:
    type: "array"
    required: true
    items:
      type: "object"
      properties:
        intent_type:
          type: "string"
          required: true
          description: "EnumIntentType from omnibase_core.models.model_intent"
        target:
          type: "string"
          required: true
        payload:
          type: "object"
          required: false

  # FSM transition info
  transition:
    type: "object"
    required: true
    properties:
      from_state:
        type: "string"
        enum: ["none", "nominated", "approved", "rejected"]
      to_state:
        type: "string"
        enum: ["nominated", "approved", "rejected"]
      action:
        type: "string"

  # Reward info (for token economy Phase 2)
  reward_info:
    type: "object"
    required: false
    properties:
      base_reward:
        type: "integer"
        description: "Base token reward for golden state"
      quality_multiplier:
        type: "float"
        description: "Multiplier based on quality score"
      reuse_bonus:
        type: "integer"
        description: "Bonus tokens for reuse"
      total_reward:
        type: "integer"

  computation_time_ms:
    type: "float"
    required: true

  timestamp:
    type: "datetime"
    required: true

# FSM Definition
fsm:
  states:
    none:
      description: "No golden state exists"
      transitions:
        nominate: "nominated"

    nominated:
      description: "Pending approval"
      transitions:
        approve: "approved"
        reject: "rejected"

    approved:
      description: "Approved golden state, available for reuse"
      transitions:
        record_reuse: "approved"  # Stay in approved, increment reuse_count
        update_quality: "approved"  # Stay in approved, update quality_score

    rejected:
      description: "Rejected, cannot be used"
      transitions: {}

  transition_logic:
    nominate:
      - "Generate golden_state_id (UUID)"
      - "Set approval_status = 'nominated'"
      - "If quality_score >= 0.9 → auto-approve"
      - "Emit intent: PERSIST_STATE (save to DB)"
      - "Emit intent: NOTIFY (inform user of nomination)"

    approve:
      - "Set approval_status = 'approved'"
      - "Set approved_by and approved_at"
      - "Calculate reward_info (for Phase 2)"
      - "Emit intent: PERSIST_STATE"
      - "Emit intent: GRANT_REWARD (Phase 2 - token economy)"

    reject:
      - "Set approval_status = 'rejected'"
      - "Emit intent: PERSIST_STATE"

    record_reuse:
      - "Increment reuse_count"
      - "Calculate reuse_bonus (diminishing returns)"
      - "Emit intent: PERSIST_STATE"
      - "Emit intent: GRANT_REWARD (reuse bonus, Phase 2)"

    update_quality:
      - "Update quality_score"
      - "Recalculate reward_info"
      - "Emit intent: PERSIST_STATE"

  auto_approval_threshold: 0.9

# Reward Calculation (for Phase 2)
reward_calculation:
  base_reward: 200  # Base tokens for golden state
  quality_multiplier:
    formula: "1.0 + (quality_score - 0.9)  # 1.0 to 2.0 range"
    min: 1.0
    max: 2.0
  reuse_bonus:
    formula: |
      # Diminishing returns
      if reuse_count == 1: return 50
      if reuse_count == 2: return 40
      if reuse_count == 3: return 30
      if reuse_count >= 4: return 20
      return 0
    cap: 500  # Max total reuse bonus

# Pure FSM Properties
pure_fsm: true
intent_based_side_effects: true
side_effects: false

# Performance Targets
performance:
  target_latency_ms: 50
  max_latency_ms: 100

# ONEX Compliance
onex_compliance:
  base_class: "omnibase_core.core.infrastructure_service_bases.NodeReducerService"
  method_signature: "async def execute_reduction(self, contract: ModelContractReducer) -> ModelReducerOutput"
  pure_fsm: true
  emits_intents: true
  thread_safe: true

# Testing Requirements
testing:
  unit_tests:
    - "Test FSM transition: none → nominated"
    - "Test FSM transition: nominated → approved"
    - "Test FSM transition: nominated → rejected"
    - "Test auto-approval (quality >= 0.9)"
    - "Test record_reuse (increment counter)"
    - "Test update_quality"
    - "Test intent emission (PERSIST_STATE, GRANT_REWARD)"
    - "Test reward calculation (base + multiplier + bonus)"

  fsm_scenarios:
    - name: "high_quality_auto_approve"
      action: "nominate"
      quality_score: 0.95
      expected_state: "approved"
      expected_reward: 210  # 200 * 1.05

    - name: "manual_approval"
      events:
        - action: "nominate"
          quality_score: 0.85
        - action: "approve"
          approved_by: "admin"
      expected_final_state: "approved"

    - name: "reuse_bonus"
      events:
        - action: "nominate"
          quality_score: 0.95
        - action: "record_reuse"
        - action: "record_reuse"
      expected_reuse_count: 2
      expected_reuse_bonus: 90  # 50 + 40

  mocks:
    - "MockDatabaseProtocol for intent execution"
