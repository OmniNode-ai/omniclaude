# SPDX-FileCopyrightText: 2025 OmniNode.ai Inc.
# SPDX-License-Identifier: MIT
---
# ONEX Contract v2.0
contract_version: "2.0"
node_type: "reducer"
node_name: "ErrorSuccessMappingReducer"
description: "Aggregate error→success patterns using FSM with intent-based side effects"

# Associated Documents (ONEX Linked Documents Pattern)
associated_documents:
  architecture:
    - path: "docs/analysis/DEBUG_REWARDS_CLARIFICATION_ANALYSIS.md"
      purpose: "Error-success mapping for debug intelligence"

  implementation:
    - path: "omniclaude/debug_loop/node_error_success_mapping_reducer.py"
      purpose: "Reducer node for error-success correlation (to be implemented)"
    - path: "migrations/001_debug_loop_core_schema.sql"
      purpose: "debug_error_success_mappings table schema"

  implementation_plans:
    - path: "docs/planning/DEBUG_LOOP_IMPLEMENTATION_PLAN.md"
      section: "Week 4: Error→Success Mapping & Golden States"
      relationship: "implementation_guide"
      description: "Error-to-success mapping with confidence tracking (Days 15-18)"

  related_contracts:
    - path: "contracts/debug_loop/debug_loop_orchestrator.yaml"
      relationship: "orchestrated_by"
      description: "Orchestrated by DebugLoopOrchestrator workflow"
    - path: "contracts/debug_loop/error_pattern_extractor_compute.yaml"
      relationship: "depends_on"
      description: "Receives normalized error patterns for mapping"

  external_systems:
    - name: "PostgreSQL (omnibase_infra)"
      host: "localhost:5436"
      table: "debug_error_success_mappings"
      relationship: "state_persistence"
      description: "Stores error→success mappings with confidence scores"

  algorithms:
    - name: "FSM State Machine"
      states: ["new", "tracking", "confident", "deprecated"]
      transitions: ["register_success", "register_failure", "update_confidence"]
      relationship: "fsm_definition"
      description: "Pure FSM with intent-based side effects for error mapping"
    - name: "Confidence Calculation"
      formula: "confidence = success_count / (success_count + failure_count)"
      relationship: "confidence_algorithm"
      description: "Automatic confidence score calculation on state transitions"

  configuration:
    - path: "config/settings.py"
      relationship: "database_config"
      description: "PostgreSQL connection for state persistence via intents"

  documentation:
    - path: "CLAUDE.md"
      section: "Agent Observability & Traceability"
      relationship: "observability_guide"
      description: "Error tracking and retry correlation"

# omnibase_core Models Used
models:
  from_omnibase_core:
    - "omnibase_core.errors.model_onex_error.ModelOnexError"
    - "omnibase_core.errors.error_codes.EnumCoreErrorCode"
    - "omnibase_core.models.model_intent.ModelIntent"
    - "omnibase_core.models.model_intent.EnumIntentType"

# Input Contract
input:
  # Current state (from previous reduction or DB)
  current_state:
    type: "object"
    required: false
    default: null
    description: "Current mapping state (null if first event)"
    properties:
      mapping_id:
        type: "string"
        format: "uuid"
      error_pattern:
        type: "string"
      error_signature:
        type: "string"
      successful_attempt_id:
        type: "string"
        format: "uuid"
      failed_attempt_ids:
        type: "array"
        items:
          type: "string"
      success_count:
        type: "integer"
      failure_count:
        type: "integer"
      confidence_score:
        type: "float"

  # Action (event to reduce)
  action:
    type: "enum"
    values: ["register_success", "register_failure", "update_confidence"]
    required: true

  # Payload (action data)
  payload:
    type: "object"
    required: true
    properties:
      attempt_id:
        type: "string"
        format: "uuid"
        required: true
      error_type:
        type: "string"
        required: true
      error_pattern:
        type: "string"
        required: true
      error_signature:
        type: "string"
        required: true
      stf_ids:
        type: "array"
        items:
          type: "string"
        required: false
      successful_approach:
        type: "string"
        required_for_action: ["register_success"]

# Output Contract
output:
  # New state (after FSM transition)
  new_state:
    type: "object"
    required: true
    properties:
      mapping_id:
        type: "string"
        format: "uuid"
      error_pattern:
        type: "string"
      error_signature:
        type: "string"
      successful_attempt_id:
        type: "string"
        format: "uuid"
      failed_attempt_ids:
        type: "array"
        items:
          type: "string"
      success_count:
        type: "integer"
      failure_count:
        type: "integer"
      confidence_score:
        type: "float"
        min: 0.0
        max: 1.0

  # Intents (side effects to execute)
  intents:
    type: "array"
    required: true
    items:
      type: "object"
      properties:
        intent_type:
          type: "enum"
          enum_ref: "EnumIntentType"
          required: true
          description: "Intent type from omnibase_core.models.model_intent.EnumIntentType"
        target:
          type: "string"
          required: true
          description: "Target node or resource"
        payload:
          type: "object"
          required: false
          description: "Intent-specific payload data"
          properties: {}
          additional_properties: true

  # FSM transition info
  transition:
    type: "object"
    required: true
    properties:
      from_state:
        type: "string"
        enum: ["new", "tracking", "confident", "deprecated"]
      to_state:
        type: "string"
        enum: ["new", "tracking", "confident", "deprecated"]
      action:
        type: "string"

  computation_time_ms:
    type: "float"
    required: true

  timestamp:
    type: "datetime"
    required: true

# FSM Definition
fsm:
  states:
    new:
      description: "First error→success mapping created"
      transitions:
        register_success: "tracking"
        register_failure: "tracking"

    tracking:
      description: "Accumulating success/failure data"
      transitions:
        register_success: "tracking"  # May transition to confident
        register_failure: "tracking"
        update_confidence: "confident"

    confident:
      description: "High confidence mapping (confidence >= 0.8)"
      transitions:
        register_success: "confident"
        register_failure: "tracking"  # May decrease confidence

    deprecated:
      description: "Mapping no longer valid (too many failures)"
      transitions: {}

  transition_logic:
    register_success:
      - "Increment success_count"
      - "Add attempt_id to successful_attempt_id (if first) or successful_stf_ids"
      - "Recalculate confidence_score"
      - "If confidence >= 0.8 → confident state"
      - "Emit intent: PERSIST_STATE (save to DB)"

    register_failure:
      - "Increment failure_count"
      - "Add attempt_id to failed_attempt_ids"
      - "Recalculate confidence_score"
      - "If confidence < 0.5 → tracking state"
      - "Emit intent: PERSIST_STATE"

  confidence_formula: |
    # Pure FSM calculation
    total = success_count + failure_count
    confidence = success_count / total if total > 0 else 0.0
    confidence = max(0.1, min(1.0, confidence))  # Clamp to [0.1, 1.0]

# Pure FSM Properties
pure_fsm: true
intent_based_side_effects: true
side_effects: false  # No direct side effects, only intents

# Performance Targets
performance:
  target_latency_ms: 50
  max_latency_ms: 100

# ONEX Compliance
onex_compliance:
  base_class: "omnibase_core.core.infrastructure_service_bases.NodeReducerService"
  method_signature: "async def execute_reduction(self, contract: ModelContractReducer) -> ModelReducerOutput"
  pure_fsm: true
  emits_intents: true
  thread_safe: true

# Testing Requirements
testing:
  unit_tests:
    - "Test FSM transition: new → tracking (first success)"
    - "Test FSM transition: tracking → confident (confidence >= 0.8)"
    - "Test FSM transition: confident → tracking (failure drops confidence)"
    - "Test confidence calculation (success / total)"
    - "Test intent emission (PERSIST_STATE)"
    - "Test state immutability (no direct mutation)"

  fsm_scenarios:
    - name: "new_to_confident"
      events:
        - action: "register_success"
        - action: "register_success"
        - action: "register_success"
      expected_final_state: "confident"
      expected_confidence: 1.0

    - name: "tracking_with_mixed_results"
      events:
        - action: "register_success"
        - action: "register_failure"
        - action: "register_success"
      expected_confidence: 0.67  # 2 success / 3 total

  mocks:
    - "MockDatabaseProtocol for intent execution"
